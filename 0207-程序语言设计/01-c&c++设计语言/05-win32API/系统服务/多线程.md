[TOC]

# 创建线程
## 描述
### 线程内核对象
- 调用 `CreateThread` 函数会在系统中创建一个线程内核对象。
- 线程内核对象是一个小型数据结构，用于操作系统管理线程，包含线程的统计信息。

### 进程和线程关系
- 线程内核对象与线程本身不同，是一个较小的数据结构。
- 类似于进程和进程内核对象之间的关系。
- 操作系统使用线程内核对象管理线程，可以看作是线程的统计信息集合。

### 线程运行环境
- 线程内核对象所在的进程地址空间的内存分配给线程堆栈使用。
- 新线程在创建它的线程的上下文中运行，可以访问进程内核对象的所有句柄、进程中的所有内存以及同一个进程中其他所有线程的堆栈。
- 这使得同一进程中的多个线程之间可以轻松地进行通信。

### 注意事项
- `CreateThread` 是用于创建线程的 Windows 函数，但在 C/C++ 代码中不推荐直接调用。
- 推荐使用 Microsoft C++ 运行库函数 `_beginthreadex` 替代 `CreateThread`。
- 如果使用其他编译器，应使用提供商提供的相应替代函数，确保正确的线程创建方式。
- 后续将详细解释 `_beginthreadex` 函数的用途和重要性。

## CreateThread函数

```C++
HANDLE CreateThread(
    PSECURITY_ATTRIBUTES    psa,
    DWORD                   cbStackSize,
    PTHREAD_START_ROUTINE   pfnStartAddr,
    PVOID                   pvParam,
    DWORD                   dwCreateFlags,
    PDWORD                  pdwThreadID);
```

### 参数详解
- **`psa` - 安全属性**
   - **类型：** `PSECURITY_ATTRIBUTES`
   - **描述：**
     - 如果想使用线程内核对象的默认安全属性，可以向此参数传入 `NULL`。
     - 如果希望所有子进程都能继承到这个线程对象的句柄，必须指定一个 `SECURITY_ATTRIBUTES` 结构，该结构的 `bInheritHandle` 成员初始化为 `TRUE`。

- **`cbStackSize` - 函数堆栈大小**
   - **类型：** `DWORD`
   - **范围：** `0, <0`
   - **描述：**
     - 用于指定线程堆栈可以使用的地址空间大小。
     - `cbStackSize` 使用了可执行文件内部的一个值，可以通过链接器的 `/STACK` 开关进行控制。
     - `/STACK:[reserve] [,commit]` 是链接器的开关，其中 `reserve` 用于设置系统为线程堆栈预留的地址空间大小，默认为 1MB。
     - `commit` 参数指定最初应为堆栈的保留区域提交多少物理存储空间，默认为 1 页。
     - 如果线程堆栈溢出，系统会捕获异常并动态增大线程堆栈。
     - 保留空间大小由 `/STACK` 链接器开关或 `cbStack` 的值决定，取其中较大的那一个。
     - 提交的存储空间大小与传递的 `csStack` 参数值匹配。
     - 如果为 `cbStack` 参数传入 0 值，`CreateThread` 函数会保留一个区域，并提交由 `/STACK` 链接器开关指定的存储量。
     - 保留空间的容量设定了堆栈空间的上限，有助于捕获代码中的无穷递归 bug，避免应用程序耗尽物理内存。

- **`pfnStartAddr` - 线程函数地址**
   - **类型：** `PTHREAD_START_ROUTINE`
   - **描述：**
     - 线程执行的线程函数地址。
     - 创建多个线程时，可以让它们使用同一个函数地址作为起点。

- **`pvParam` - 线程函数的参数**
   - **类型：** `PVOID`
   - **描述：**
     - 传递到线程函数的参数。

- **`dwCreateFlags` - 额外构造标志**
   - **类型：** `DWORD`
   - **范围：** `0 | CREATE_SUSPENDED`
   - **描述：**
     - 如果值为 0，线程创建之后立即就可以进行调度。
     - 如果值为 `CREATE_SUSPENDED`，系统将创建并初始化线程，但会暂停该线程的运行，使其无法进行调度。

- **`pdwThreadID` - 新线程的ID**
   - **类型：** `PDWORD`
   - **描述：**
     - 初始化线程的ID，可以为这个参数传递 `NULL`，表示对线程ID没有兴趣。

# 终止线程

## 描述
线程可以通过以下4种方法来终止运行
- **线程函数返回（强烈推荐）：**
   - 设计线程函数时，确保线程在需要终止时通过返回来结束。
   - 确保线程函数返回，以执行正确的应用程序清理工作，包括 C++ 对象的析构函数、释放线程堆栈内存等。

- **ExitThread 函数（避免使用）：**
   - 使用 `ExitThread` 函数会终止线程的运行，但不会执行 C/C++ 资源的销毁，不推荐使用。
   - 直接从线程函数返回是更好的做法，避免手动调用 `ExitThread`。

- **TerminateThread 函数（避免使用）：**
   - `TerminateThread` 可以异步地终止任何线程，但不推荐使用。
   - 是异步的，不保证线程在函数返回时已经终止。
   - 由于无法通知线程被“杀死”，不利于线程的正确清理，可能导致资源泄漏。

- **包含线程的进程终止运行（避免使用）：**
   - 不推荐通过终止整个进程来结束线程，因为这样会导致整个进程的终止。
   - 不利于精细控制线程的生命周期，可能引起资源泄漏。

**注意事项：**
- 对于线程的终止，推荐使用线程函数返回的方式，确保资源正确清理。
- 避免使用 `ExitThread` 和 `TerminateThread`，因为它们可能导致资源泄漏和不确定的行为。
- 保证线程的正常终止，有助于程序的健壮性和资源管理。

## ExitThread 函数

```C
VOID ExitThread(DWORD dwExitCode);
```

### **参数**
- `dwExitCode`-退出代码
  - **类型：** `DWORD`
  - **描述：** 线程终止运行时，`dwExitCode` 的值会成为线程的退出代码。

## TerminateThread 函数

```C
BOOL TerminateThread(
    HANDLE hThread,
    DWORD  dwExitCode);
```

### **参数**
- `hThread`-线程的句柄
  - **类型：** `HANDLE`
  - **描述：** 标识要终止的那个线程的句柄。
- `dwExitCode`-退出代码
  - **类型：** `DWORD`
  - **描述：** 线程终止运行时，`dwExitCode` 的值会成为线程的退出代码。

